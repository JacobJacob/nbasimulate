{% load common_extras %}
<script type="text/javascript" src="/site_media/js/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/site_media/js/rpc.js"></script>
<script type="text/javascript" src="/site_media/js/jquery/ui/ui.core.js"></script>
<script type="text/javascript" src="/site_media/js/jquery/ui/ui.dialog.js"></script>
<link rel="stylesheet" href="/site_media/js/jquery/ui/themes/flora/flora.all.css" type="text/css" media="screen" title="no title" />
<link href="/site_media/css/skin.css" rel="stylesheet" type="text/css" />
<meta http-equiv="content-type" content="text/html; charset=utf8" />
<script type="text/javascript">
     
  service = new rpc.ServiceProxy("/services/player/", {asynchronous:false, methods: ['freeplayer_auction', 'get_free_auction_info', 'cancel_attention_player']});
  $(document).ready(function(){
    
	 $('a.player_name').click(function() {
	     var id = $(this).parent().parent().attr('no');
	     $.ajax({
		    url: '{% url freeplayer-detail %}?no=' + id,
		    type: 'get',
		    datatype: 'html',
		    timeout: 1000,
		    error: function(error){
		        alert(error.message);
		    },
		    success: function(html){
		        $('#play_detail').html(html);
		    }
		});
	 });
	 
	 $('a.cancel_attention').click(function() {
	     var no = $(this).parent().parent().attr('no');
	     try{
	         var result = service.cancel_attention_player(no);
	         if(result == 1){
	            alert('您已经取消对该球员的关注');
                $(this).parent().parent().remove();
             }else{
                alert('取消关注出错!');
             }
	     }catch(error){
	         alert(error);
	     }
	 });
	 
	 $('a.auction').click(function() {
	     var no = $(this).parent().parent().attr('no');
	     try{
	         var data = service.get_free_auction_info(no);
	         var result = data[0];
	         if(result==-1){
	            alert('该球员已经截止!');
	            return;
	         }else if(result == -2){
	            alert('您已经出过价了,不允许重复出价!');
	            return;
	         }
	     }catch(error){
	         alert('出现未知异常!,请重试');
	     }
	     $("#no").val(no);
	     $("#min_price").html(data[1]);
	     $("#free_funds").html(data[2]);
	     $("#auction_player_dialog").show().dialog({
	         height: 180, width: 300, modal: false,
             title: '自由球员竞拍',
	         overlay: {
               opacity: 0.5, 
               background: "black" 
             }
         });
         $("#auction_player_dialog").dialog('open');
	 });
	 
	  
	 $('#update_button').click(function(){
	     var no = $('#no').val();
	     var price = $('#price').val();
	     if(!price){
	       alert('您必需填写您想要购买的价格!');
	       return;
	     }
         try{
            var result = service.freeplayer_auction(no, price);
            if(result==1){
                alert('竟拍成功!');
                $("#auction_player_dialog").dialog('close');
            }else if(result==-2){
                alert('您的资金不足!');
            }else if(result==-3){
                alert('您已经出过价,不可以重复出价!');
            }else if(result==-5){
                alert('您出的价格低于当前价格!');
            }else{
                alert('球员竟拍出错,请重试!');
            }
         }catch(error){
            alert(error.message);
         }
     });
});
  
</script>
<style type="text/css">
<!--
body {
	margin-left: 0px;
	margin-top: 0px;
	margin-right: 0px;
	margin-bottom: 0px;
	background-color: #eef2fb;
}
-->
</style>
<body>
<div id="left">
<table width="99%" border=0 cellpadding=0 cellspacing=0 class="normal_table">
  <thead>
    <th class="left">名字</th>
    <th>年龄</th>
    <th>位置</th>
    <th>身高</a></th>
    <th>体重</th>
    <th>市场</th>
    <th>综合</th>
    <th>次数</th>
    <th>买主</th>
    <th>剩余时间</th>
    <th class="right">操作</th>
  </thead>
  <tbody>
    {% if infos %}
      {% for info in infos %}
       <tr no="{{ info.no }}">
        <td class="left name"><a class="player_name">{{ info.name }}</a></td>
        <td class="align_center">{{ info.age }}</td>
        <td class="align_center">{{ info.position }}</td>
        <td class="align_center">{{ info.stature }}</td>
        <td class="align_center">{{ info.avoirdupois }}</td>
        <td class="align_center">
          {% ifequal info.type 1 %}
             职
          {% else %}
             青
          {% endifequal %}
        </td>
        <td class="align_center">{{ info.ability|format_number }}</td>
        <td class="number">{{ info.bid_count }}</td>
        <td class="align_center">
           {{ info.current_price }}/
           {% if info.current_team_id %}
              {{ info.current_team_id|team_username}}
           {% else %}
              --
           {% endif %}
        </td>
        <td class="align_center">{{ info.lave_time|format_lave_time }}</td>
        <td class="right align_center">
          {% ifless info.lave_time 0 %}
             {% ifequal info.auction_status 1 %}
               <a>成交详情</a>
             {% else %}
                  {% ifequal info.auction_status 2 %}
                    未成交
                  {% else %}
                    结算中
                  {% endifequal %}
             {% endifequal %}
          {% else %}
             <a class="auction">出价</a>|
             <a class="cancel_attention">取消关注</a>
          {% endifless %}
        </td>
       </tr>
      {% endfor %}
    {% endif %}
  </tbody>
</table>
</div>
<div id="side"><span id="play_detail" ></span></div>
<div id="auction_player_dialog" class="flora" style="display: none;">
    <form id="auction_player_form">
        <input type="hidden" id="no"/>
	    <p>
			<label>您至少出价:</label>
			<span id="min_price"></span>
		</p>
		<p>
			<label>价格:</label>
			<span><input name="price" id="price"/></span>
		</p>
		<p>
			<label>可用资金:</label>
			<span id="free_funds"></span>
		</p>
		<p>
		  <input id="update_button" type="button" value="竟拍" />
		</p>
    </form>
</div>
</body>