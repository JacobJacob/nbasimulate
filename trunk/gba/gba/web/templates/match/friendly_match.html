{% load common_extras %}
<script type="text/javascript" src="/site_media/js/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/site_media/js/rpc.js"></script>
<script type="text/javascript" src="/site_media/js/jquery/ui/ui.core.js"></script>
<script type="text/javascript" src="/site_media/js/jquery/ui/ui.dialog.js"></script>
<link rel="stylesheet" href="/site_media/js/jquery/ui/themes/flora/flora.all.css" type="text/css" media="screen" title="no title" />
<link href="/site_media/css/skin.css" rel="stylesheet" type="text/css" />
<meta http-equiv="Content-Type" content="text/html; charset=utf8" />
<script type="text/javascript">

      service = new rpc.ServiceProxy("/services/player/", {asynchronous:false, methods: ['profession_player_detail', 'update_profession_player']});

	  $(document).ready(function(){
	    
		 $('a.player_name').click(function() {
		     var id = $(this).parent().parent().attr('id');
		     $.ajax({
			    url: '{% url freeplayer-detail %}?id=' + id,
			    type: 'GET',
			    dataType: 'html',
			    timeout: 1000,
			    error: function(error){
			        alert(error);
			    },
			    success: function(html){
			        $('#play_detail').html(html);
			    }
			});
		 });
		 
		 $('a.edit_player').click(function() {
		      var no = $(this).parent().parent().attr('no');
	          try{
	              var data = service.profession_player_detail(no);
	          }catch(error){
	              alert(error.message);
	          }
	          var info = data[0];
	          var player_no = info['player_no'];
	          var position = info['position'];
	          var in_use_nos = data[1]
	          
	          $('#no').val(no);
	          $('#player_name').val(info['name']);
	          $('#player_no').val(player_no);
	          
	          $("select[name='player_no'] option").each(function(){
	             $(this).remove();
	          });
	          for(var i=0; i <= 30; i++){
	              if(i==player_no){
	                  $("<option value='" + i + "' selected>" + i + "</option>").appendTo($("select[name='player_no']")); 
	              }else{
	                 var in_use = false;
	                 for(j=0; j < in_use_nos.length;j++){
	                    if(in_use_nos[j]==i){
	                        in_use = true;
	                        break
	                    }
	                 }
	                 if(!in_use){
	                    $("<option value='" + i + "'>" + i + "</option>").appendTo($("select[name='player_no']")); 
	                 }
	              }
	          }
	          
	          $("select[name='position'] option").each(function(){
	              if($(this).val()==position){
	                 $(this).attr('selected', true);
	              }
	          });
	          $("#edit_player_dialog").show().dialog({
		         height: 250, width: 300, modal: false,
	             title: '球员信息更改',
		         overlay: {
                   opacity: 0.5, 
                   background: "black" 
                 }
	          });
              $("#edit_player_dialog").dialog('open');

		 });
		 
		 $('#update_button').click(function(){
		     var no = $('#no').val();
		     var name = $('#player_name').val();
	         var player_no = $('#player_no').val();
	         var position = $('#position').val();
	         var data = {'no': no, 'name': name, 'player_no': player_no, 'position': position}
	         try{
	            var result = service.update_profession_player(data);
	            if(result==1){
	                alert('球员信息更新成功');
	            }else if(result==0){
	                alert('球员信息更新失败,请联系管理员');
	            }else{
	                alert('该球员不在您的队中，您无权更改');
	            }
	         }catch(error){
	            alert(error.message);
	         }
	         $("#edit_player_dialog").dialog('close');
		 });
		 
	  });
</script>
<style type="text/css">
<!--
body {
	margin-left: 0px;
	margin-top: 0px;
	margin-right: 0px;
	margin-bottom: 0px;
	background-color: #EEF2FB;
}
-->
</style>
<body>
<table width="99%">
<tr>
<td width="60%" valign="top">
<TABLE width="99%" border=0 cellPadding=0 cellSpacing=0 class="player">
  <thead>
    <th>&nbsp;</th>
    <th>主场</th>
    <th>比分</th>
    <th>客场</th>
    <th>时间</th>
    <th class="right">操作</th>
  </thead>
  <tbody>
    {% if infos %}
      {% for info in infos %}
       <tr id="{{ info.id }}" no="{{ info.no }}">
        <td>{{ info.type }}</td>
        <td>{{ info.home_team_id|team_name }}</td>
        <td>
           {% if info.point %}
              {{ info.point }}
           {% else %}
              -- : --
           {% endif %}
        </td>
        <td>{{ info.guest_team_id|team_name }}</td>
        <td>{{ info.send_time }}</td>
        <td class="right">
           {% ifequal info.status 2 %}
               <a href="{% url match-stat %}?match_id={{info.id}}" target="_blank">查看战报</a>
           {% else %}
             {{info.status|match_status}}|<a class="edit_player">取消</a>
           {% endifequal %}
        </td>
       </tr>
      {% endfor %}
    {% endif %}
  </tbody>
</table>
</td>
<td class="detail_td">
<span id="play_detail" ></span>
</td>
</tr>
</table>
<div id="edit_player_dialog" class="flora" style="display: none;">
    <form id="edit_player_form">
        <input type="hidden" id="no"/>
    	<p>
    		<label>名字:</label>
			<span><input id="player_name" type="text"/></span>
	    </p>
	    <p>
            <label>号码:</label>
			<span>
			  <select name="player_no" id="player_no">
			  </select>
			</span>
	    </p>
	    <p>
			<label>位置:</label>
			<span>
			  <select name="position" id="position">
			    <option value="PG">组织后卫</option>
			    <option value="SG">得分后卫</option>
			    <option value="SF">小前锋</option>
			    <option value="PF">大前锋</option>
			    <option value="C">中锋</option>
			  </select>
			</span>
		</p>
		<p>
		  <input id="update_button" type="button" value="更新" />
		</p>
    </form>
</div>
</body>